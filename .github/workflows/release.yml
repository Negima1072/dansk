name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        node-version: [16.x]
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - name: Build
      run: |
        npm install
        ls
        npm run build
    - name: Prepare
      run: |
        cp -f README.md dist
    - name: Package for Chrome
      run: |
        cp -rf dist/ dist_chrome/
        rm -rf dist_chrome/manifest.firefox.json
        zip -r dansk-chrome-${GITHUB_REF##*/}.zip dist_chrome
    - name: Submit to Chrome Web Store
      run: |
        npx -y chrome-webstore-upload-cli@3 upload --source dansk-chrome-${GITHUB_REF##*/}.zip --auto-publish
      env:
        EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
    - name: Package for Firefox
      run: |
        cp -rf dist/ dist_firefox/
        rm -rf dist_firefox/manifest.json
        mv dist_firefox/manifest.firefox.json dist_firefox/manifest.json
    - name: Sign for Firefox
      run: |
        npx -y web-ext@7 sign --source-dir dist_firefox --use-submission-api --channel unlisted
        mv web-ext-artifacts/*.xpi dansk-firefox-${GITHUB_REF##*/}.xpi
      env:
        WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
        WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
    - name: Create Change Log
      run: |
        CHANGELOG=$(sed -n "/### ${GITHUB_REF##*/}/,/### v/p" README.md | sed '${/^###/d}' | sed '1,2d;$d')
        echo "$CHANGELOG" >| CHANGELOG.md
    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        body_path: CHANGELOG.md
        files: |
          dansk-chrome-${GITHUB_REF##*/}.zip
          dansk-firefox-${GITHUB_REF##*/}.xpi
    - name: Post to Discord
      run: |
        WEBHOOK_URL="https://discord.com/api/webhooks/1000620069820309595/6SJxaZVl_lH456RuCF7ZUoGJ8Wn0Qo4e_2AuGVJoa_CWTPOpFaLH1kjNSPpHjYp9cF1o"
        RELEASE_TAG=${GITHUB_REF##*/}
        BODY="🎉 **だんスク 新バージョンリリース** 🎉\n\nバージョン：\`$RELEASE_TAG\`\n\n📥 **Chrome 版**\n<https://chrome.google.com/webstore/detail/dansukumizu/cjmnakgpnakmaemloaoaidbohgcldpcc>\n*(ストア反映に時間がかかる場合があります)*\n\n📥 **Firefox 版**\n下のリンクからダウンロードして有効化してください\n\n💬 ご意見・ご要望は <#441986140179005440> にお願いします。"
        curl -X POST $WEBHOOK_URL \
          -H "Content-Type: multipart/form-data" \
          -F "file1=@CHANGELOG.md" \
          -F "file2=@dansk-chrome-${GITHUB_REF##*/}.zip" \
          -F "file3=@dansk-firefox-${GITHUB_REF##*/}.xpi" \
          -F "payload_json={\"content\":\"$BODY\"}"
