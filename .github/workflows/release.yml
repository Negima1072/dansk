name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        node-version: [20.x]
    steps:
    - uses: actions/checkout@v4
    - uses: pnpm/action-setup@v4
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: "pnpm"
    - name: Install dependencies
      run: pnpm install
    - name: Submit to Chrome Web Store
      run: |
        pnpm zip
        mv .output/*.zip dansk-chrome-${GITHUB_REF##*/}.zip
        pnpm dlx chrome-webstore-upload-cli@3 upload --source dansk-chrome-${GITHUB_REF##*/}.zip --auto-publish
      env:
        EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
    - name: Sign for Firefox
      run: |
        pnpm build:firefox
        pnpm dlx web-ext@8 sign --source-dir .output/firefox-mv3 --use-submission-api --channel unlisted
        mv web-ext-artifacts/*.xpi dansk-firefox-${GITHUB_REF##*/}.xpi
      env:
        WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
        WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
    - name: Create Change Log
      run: |
        CHANGELOG=$(sed -n "/### ${GITHUB_REF##*/}/,/### v/p" README.md | sed '${/^###/d}' | sed '1,2d;$d')
        echo "$CHANGELOG" >| CHANGELOG.md
    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        body_path: CHANGELOG.md
        files: |
          *.zip
          *.xpi
    - name: Post to Discord
      run: |
        WEBHOOK_URL="https://discord.com/api/webhooks/1000620069820309595/6SJxaZVl_lH456RuCF7ZUoGJ8Wn0Qo4e_2AuGVJoa_CWTPOpFaLH1kjNSPpHjYp9cF1o"
        RELEASE_TAG=${GITHUB_REF##*/}
        BODY="ğŸ‰ **ã ã‚“ã‚¹ã‚¯ æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹** ğŸ‰\n\nãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼š\`$RELEASE_TAG\`\n\nğŸ“¥ **Chrome ç‰ˆ**\n<https://chrome.google.com/webstore/detail/dansukumizu/cjmnakgpnakmaemloaoaidbohgcldpcc>\n*(ã‚¹ãƒˆã‚¢åæ˜ ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)*\n\nğŸ“¥ **Firefox ç‰ˆ**\nä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„\n\nğŸ’¬ ã”æ„è¦‹ãƒ»ã”è¦æœ›ã¯ <#441986140179005440> ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚"
        curl -X POST $WEBHOOK_URL \
          -H "Content-Type: multipart/form-data" \
          -F "file1=@CHANGELOG.md" \
          -F "file2=@dansk-chrome-${GITHUB_REF##*/}.zip" \
          -F "file3=@dansk-firefox-${GITHUB_REF##*/}.xpi" \
          -F "payload_json={\"content\":\"$BODY\"}"
