name: Release

on:
  push:
    branches-ignore:
      - '**'
    tags:
      - 'v*'
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        node-version: [16.x]
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - name: Build
      run: |
        npm install
        ls
        npm run build
    - name: Prepare
      run: |
        cp -f README.md dist
    - name: Package for Chrome
        cp -r dist/ dist_chrome/
        rm -rf dist_chrome/manifest.firefox.json
        zip -r dansk-chrome-${GITHUB_REF##*/}.zip dist_chrome
    - name: Submit to Chrome Web Store
      run: |
        npx chrome-webstore-upload-cli@3 upload --source dansk-chrome-${GITHUB_REF##*/}.zip --auto-publish
      env:
        EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
    - name: Package for Firefox
        cp -r dist/ dist_firefox/
        rm -rf dist_firefox/manifest.json
        mv dist_firefox/manifest.firefox.json dist_firefox/manifest.json
    - name: Sign for Firefox
      run: |
        npx web-ext@7 sign --source-dir dist_firefox --use-submission-api --channel unlisted
      env:
        WEB_EXT_API_KEY: ${{ secrets.FIREFOX_API_KEY }}
        WEB_EXT_API_SECRET: ${{ secrets.FIREFOX_API_SECRET }}
    - name: Upload Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        files: |
          dansk-chrome-${GITHUB_REF##*/}.zip
          dansk-firefox-${GITHUB_REF##*/}.xpi
    - name: Post to Discord
      run: | 
        echo '${GITHUB_REF##*/}'
        curl -X POST -F 'payload_json={"content": "Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„É™„É™„Éº„Çπ„ÅÆ„ÅäÁü•„Çâ„Åõ„Åß„Åôüòé\r„Éê„Éº„Ç∏„Éß„É≥Ôºö'${GITHUB_REF##*/}'\r„ÅîÊÑèË¶ã„Éª„ÅîË¶ÅÊúõ„ÅØ <#441986140179005440> „Å´„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô\rChrome ‚Üí https://chromewebstore.google.com/detail/dansukumizu/cjmnakgpnakmaemloaoaidbohgcldpcc\rFirefox ‚Üí „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶ÊúâÂäπÂåñ"}' -F "file1=@dansk-chrome-${GITHUB_REF##*/}.zip" -F "file2=@dansk-firefox-${GITHUB_REF##*/}.xpi" "https://discord.com/api/webhooks/1000620069820309595/6SJxaZVl_lH456RuCF7ZUoGJ8Wn0Qo4e_2AuGVJoa_CWTPOpFaLH1kjNSPpHjYp9cF1o"
